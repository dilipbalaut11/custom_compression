-- test storages
CREATE TABLE cmstoragetest(st1 TEXT, st2 INT);
ALTER TABLE cmstoragetest ALTER COLUMN st1 SET STORAGE EXTERNAL;
\d+ cmstoragetest
                                      Table "public.cmstoragetest"
 Column |  Type   | Collation | Nullable | Default | Storage  | Compression | Stats target | Description 
--------+---------+-----------+----------+---------+----------+-------------+--------------+-------------
 st1    | text    |           |          |         | external | pglz        |              | 
 st2    | integer |           |          |         | plain    |             |              | 

ALTER TABLE cmstoragetest ALTER COLUMN st1 SET STORAGE MAIN;
\d+ cmstoragetest
                                      Table "public.cmstoragetest"
 Column |  Type   | Collation | Nullable | Default | Storage | Compression | Stats target | Description 
--------+---------+-----------+----------+---------+---------+-------------+--------------+-------------
 st1    | text    |           |          |         | main    | pglz        |              | 
 st2    | integer |           |          |         | plain   |             |              | 

ALTER TABLE cmstoragetest ALTER COLUMN st1 SET STORAGE PLAIN;
\d+ cmstoragetest
                                      Table "public.cmstoragetest"
 Column |  Type   | Collation | Nullable | Default | Storage | Compression | Stats target | Description 
--------+---------+-----------+----------+---------+---------+-------------+--------------+-------------
 st1    | text    |           |          |         | plain   | pglz        |              | 
 st2    | integer |           |          |         | plain   |             |              | 

ALTER TABLE cmstoragetest ALTER COLUMN st1 SET STORAGE EXTENDED;
\d+ cmstoragetest
                                      Table "public.cmstoragetest"
 Column |  Type   | Collation | Nullable | Default | Storage  | Compression | Stats target | Description 
--------+---------+-----------+----------+---------+----------+-------------+--------------+-------------
 st1    | text    |           |          |         | extended | pglz        |              | 
 st2    | integer |           |          |         | plain    |             |              | 

DROP TABLE cmstoragetest;
CREATE TABLE cmdata(f1 text COMPRESSION pglz);
INSERT INTO cmdata VALUES(repeat('1234567890',1000));
INSERT INTO cmdata VALUES(repeat('1234567890',1001));
-- copy with table creation
SELECT * INTO cmmove1 FROM cmdata;
-- we update using datum from different table
CREATE TABLE cmmove2(f1 text COMPRESSION pglz);
INSERT INTO cmmove2 VALUES (repeat('1234567890',1004));
UPDATE cmmove2 SET f1 = cmdata.f1 FROM cmdata;
-- copy to existing table
CREATE TABLE cmmove3(f1 text COMPRESSION pglz);
INSERT INTO cmmove3 SELECT * FROM cmdata;
-- drop original compression information
DROP TABLE cmdata;
-- check data is okdd
SELECT length(f1) FROM cmmove1;
 length 
--------
  10000
  10010
(2 rows)

SELECT length(f1) FROM cmmove2;
 length 
--------
  10000
(1 row)

SELECT length(f1) FROM cmmove3;
 length 
--------
  10000
  10010
(2 rows)

-- zlib compression
CREATE TABLE zlibtest(f1 TEXT COMPRESSION zlib);
CREATE TABLE zlibtest(f1 TEXT COMPRESSION zlib);
ERROR:  relation "zlibtest" already exists
CREATE TABLE zlibtest(f1 TEXT COMPRESSION zlib);
ERROR:  relation "zlibtest" already exists
INSERT INTO zlibtest VALUES(repeat('1234567890',1004));
INSERT INTO zlibtest VALUES(repeat('1234567890 one two three',1004));
SELECT length(f1) FROM zlibtest;
 length 
--------
  10040
  24096
(2 rows)

-- alter compression method with rewrite
ALTER TABLE cmmove2 ALTER COLUMN f1 SET COMPRESSION zlib;
\d+ cmmove2
                                        Table "public.cmmove2"
 Column | Type | Collation | Nullable | Default | Storage  | Compression | Stats target | Description 
--------+------+-----------+----------+---------+----------+-------------+--------------+-------------
 f1     | text |           |          |         | extended | zlib        |              | 

ALTER TABLE cmmove2 ALTER COLUMN f1 SET COMPRESSION pglz;
\d+ cmmove2
                                        Table "public.cmmove2"
 Column | Type | Collation | Nullable | Default | Storage  | Compression | Stats target | Description 
--------+------+-----------+----------+---------+----------+-------------+--------------+-------------
 f1     | text |           |          |         | extended | pglz        |              | 

DROP TABLE cmmove1, cmmove2, cmmove3, zlibtest;
